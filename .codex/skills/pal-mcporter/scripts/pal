#!/usr/bin/env bash
set -euo pipefail

# Wrapper around the bundled mcporter-generated PAL CLI.
#
# - Tool calls run via `scripts/pal-cli.js` (no runtime generation/caching).
# - `examples` and `selftest` are helper commands for humans/agents.

MCPORTER_VERSION="${MCPORTER_VERSION:-0.7.3}"
PAL_MCPORTER_TIMEOUT_MS="${PAL_MCPORTER_TIMEOUT_MS:-120000}"
PAL_NAME="${PAL_NAME:-pal}"

_SCRIPT_DIR="$(cd -- "$(dirname -- "${BASH_SOURCE[0]}")" && pwd -P)"
_PAL_CLI="${_SCRIPT_DIR}/pal-cli.js"
_PAL_TOOLS_PY="${_SCRIPT_DIR}/pal_tools.py"

_die() {
  echo "pal-mcporter: $*" >&2
  exit 1
}

_require_cmd() {
  command -v "$1" >/dev/null 2>&1 || _die "$1 not found"
}

_require_bundled_cli() {
  [ -f "$_PAL_CLI" ] || _die "missing bundled CLI: $_PAL_CLI"
  _require_cmd node
}

_mcporter_pkg() {
  _require_cmd npx
  echo "mcporter@${MCPORTER_VERSION}"
}

_pal_server_script() {
  # Adapted from upstream pal-mcp-server README.
  cat <<'EOF'
for p in $(which uvx 2>/dev/null) $HOME/.local/bin/uvx /opt/homebrew/bin/uvx /usr/local/bin/uvx uvx; do
  if [ -x "$p" ]; then
    exec "$p" --from "${PAL_MCP_FROM:-git+https://github.com/BeehiveInnovations/pal-mcp-server.git}" pal-mcp-server
  fi
done
echo "uvx not found. Install uv/uvx, or put uvx on PATH." >&2
exit 1
EOF
}

_mcporter_list() {
  local script
  script="$(_pal_server_script)"
  npx -y "$(_mcporter_pkg)" list \
    --timeout "$PAL_MCPORTER_TIMEOUT_MS" \
    --stdio bash \
    --stdio-arg -lc \
    --stdio-arg "$script" \
    --name "$PAL_NAME" \
    "$@"
}

_run_cli() {
  _require_bundled_cli
  exec node "$_PAL_CLI" "$@"
}

_usage() {
  cat <<'EOF'
Usage:
  pal <tool> [global flags...] [tool flags...]
  pal examples
  pal selftest [--live]

Notes:
  - Tools are provided by the bundled CLI: scripts/pal-cli.js
  - Global flags must come before the tool name: pal -o json version

Env:
  OPENAI_API_KEY / GEMINI_API_KEY / OPENROUTER_API_KEY / ANTHROPIC_API_KEY  provider creds (for selftest --live)
  PAL_MCP_FROM               uvx --from source (default: git+https://github.com/BeehiveInnovations/pal-mcp-server.git)
  PAL_DEFAULT_MODEL          used by pal-mcp-server when DEFAULT_MODEL is unset (default: auto)
  DISABLED_TOOLS             PAL setting (comma-separated); unset/empty enables all
EOF
}

main() {
  local subcmd="${1:-}"
  if [ -z "$subcmd" ]; then
    _run_cli
  fi

  if [ "$subcmd" = "-h" ] || [ "$subcmd" = "--help" ] || [ "$subcmd" = "help" ]; then
    _usage
    echo "" >&2
    echo "Tool list + per-tool usage:" >&2
    echo "  bash \"$0\"" >&2
    return 0
  fi

  case "$subcmd" in
    examples)
      shift
      _require_cmd python3
      [ -f "$_PAL_TOOLS_PY" ] || _die "missing helper: $_PAL_TOOLS_PY"
      _mcporter_list --schema --json | python3 "$_PAL_TOOLS_PY" examples "$0"
      ;;
    selftest)
      shift
      local live=0
      if [ "${1:-}" = "--live" ]; then
        live=1
        shift
      fi
      [ "$#" -eq 0 ] || _die "selftest accepts at most one flag: --live"

      _require_bundled_cli
      _require_cmd python3
      [ -f "$_PAL_TOOLS_PY" ] || _die "missing helper: $_PAL_TOOLS_PY"

      local tmpdir
      tmpdir="$(mktemp -d)"
      trap 'rm -rf "${tmpdir:-}"' EXIT

      local schema_json
      schema_json="$tmpdir/pal-tools.schema.json"

      echo "pal-mcporter selftest: starting"

      echo "pal-mcporter selftest: CLI help runs"
      node "$_PAL_CLI" --help >/dev/null
      echo "ok"

      echo "pal-mcporter selftest: list --schema (json)"
      _mcporter_list --schema --json >"$schema_json"
      python3 - "$schema_json" <<'PY'
import json,sys
with open(sys.argv[1]) as f:
    data=json.load(f)
assert data.get("status") in {"ok","success"}, data.get("status")
tools=[t.get("name") for t in data.get("tools",[])]
missing=[t for t in ("version","listmodels","chat") if t not in tools]
assert not missing, f"missing tools: {missing}"
print("ok")
PY

      echo "pal-mcporter selftest: version"
      node "$_PAL_CLI" -t "$PAL_MCPORTER_TIMEOUT_MS" -o json version \
        | python3 -c 'import json,sys; data=json.load(sys.stdin); assert data.get("status") in {"success","continuation_available"}, data.get("status"); print("ok")'

      echo "pal-mcporter selftest: listmodels"
      node "$_PAL_CLI" -t "$PAL_MCPORTER_TIMEOUT_MS" -o json listmodels \
        | python3 -c 'import json,sys; data=json.load(sys.stdin); assert data.get("status") in {"success","continuation_available"}, data.get("status"); print("ok")'

      echo "pal-mcporter selftest: examples"
      bash "$0" examples >/dev/null
      echo "ok"

      if [ "$live" -eq 1 ]; then
        if [ -z "${OPENAI_API_KEY:-}" ] && [ -z "${GEMINI_API_KEY:-}" ] && [ -z "${OPENROUTER_API_KEY:-}" ] && [ -z "${ANTHROPIC_API_KEY:-}" ]; then
          _die "selftest --live requested but no provider API key found (set OPENAI_API_KEY, GEMINI_API_KEY, OPENROUTER_API_KEY, etc.)"
        fi

        _require_cmd jq
        _require_cmd git

        local selftest_cli_name=""
        if [ -n "${PAL_SELFTEST_CLI_NAME:-}" ]; then
          selftest_cli_name="$PAL_SELFTEST_CLI_NAME"
        elif command -v codex >/dev/null 2>&1; then
          selftest_cli_name="codex"
        elif command -v claude >/dev/null 2>&1; then
          selftest_cli_name="claude"
        elif command -v gemini >/dev/null 2>&1; then
          selftest_cli_name="gemini"
        fi

        local selftest_model="${PAL_SELFTEST_MODEL:-}"
        if [ -z "$selftest_model" ]; then
          selftest_model="$(
            node "$_PAL_CLI" -t "$PAL_MCPORTER_TIMEOUT_MS" -o json listmodels \
              | python3 -c '
import json,re,sys
data=json.load(sys.stdin)
text=data.get("content") or ""
m=re.search(r"`([^`]+)`\\s*-", text) or re.search(r"`([^`]+)`", text)
print(m.group(1) if m else "")
'
          )"
        fi
        [ -n "$selftest_model" ] || _die "unable to infer a model from listmodels output (set PAL_SELFTEST_MODEL)"

        export PAL_SELFTEST_CLI_NAME="$selftest_cli_name"
        export PAL_SELFTEST_MODEL="$selftest_model"

        local selftest_repo="$tmpdir/pal-mcporter-selftest-repo"
        mkdir -p "$selftest_repo"
        (cd "$selftest_repo" && git init -q) || true
        printf "pal-mcporter selftest file\n" >"$selftest_repo/pal-mcporter-selftest.txt"
        (cd "$selftest_repo" && git add pal-mcporter-selftest.txt) || true
        (cd "$selftest_repo" && git -c user.email="pal-mcporter@example.com" -c user.name="pal-mcporter" commit -q -m "init") || true
        printf "pal-mcporter selftest change\n" >>"$selftest_repo/pal-mcporter-selftest.txt"
        (cd "$selftest_repo" && git add pal-mcporter-selftest.txt) || true

        export PAL_SELFTEST_REPO_PATH="$selftest_repo"
        export PAL_SELFTEST_FILE_PATH="$selftest_repo/pal-mcporter-selftest.txt"

        local clink_cwd=""
        if [ -n "$selftest_cli_name" ]; then
          clink_cwd="$selftest_repo"
        fi

        echo "pal-mcporter selftest: chat (live)"
        local cid=""
        cid="$(
          node "$_PAL_CLI" -t "$PAL_MCPORTER_TIMEOUT_MS" -o json chat \
            --prompt "ping" \
            --working-directory-absolute-path "$PWD" \
            --model "$selftest_model" \
            | python3 -c '
import json,sys
data=json.load(sys.stdin)
assert data.get("status") in {"success","continuation_available"}, data.get("status")
cid=(data.get("continuation_offer") or {}).get("continuation_id") or ""
print(cid)
'
        )"
        [ -n "$cid" ] || _die "expected chat to return continuation_id"
        echo "ok"

        echo "pal-mcporter selftest: chat (continuation)"
        node "$_PAL_CLI" -t "$PAL_MCPORTER_TIMEOUT_MS" -o json chat \
          --prompt "follow up" \
          --working-directory-absolute-path "$PWD" \
          --model "$selftest_model" \
          --raw "{\"continuation_id\":\"$cid\"}" \
          | python3 -c '
import json,sys
raw=sys.stdin.read()
try:
    data=json.loads(raw)
except Exception:
    data=None

# In ad-hoc stdio mode, each invocation starts a fresh server process, so cross-invocation
# continuation IDs typically cannot be resumed. Accept that.
if data and data.get("status") in {"success","continuation_available"}:
    print("ok")
    raise SystemExit(0)

if "was not found" in raw or "has expired" in raw:
    print("ok (continuation not persisted in ad-hoc stdio)")
    raise SystemExit(0)

print("unexpected continuation output:", file=sys.stderr)
print(raw[:2000], file=sys.stderr)
raise SystemExit(1)
'

        echo "pal-mcporter selftest: DISABLED_TOOLS smoke"
        local disable_candidate=""
        disable_candidate="$(python3 "$_PAL_TOOLS_PY" disable-candidate "$schema_json")"
        if [ -n "$disable_candidate" ]; then
          DISABLED_TOOLS="$disable_candidate" _mcporter_list --json \
            | python3 -c '
import json,sys
raw=sys.stdin.read()
start=raw.find("{")
if start == -1:
    raise SystemExit(f"no json object found in output: {raw[:2000]!r}")
if start > 0:
    raw=raw[start:]
data=json.loads(raw)
disabled=sys.argv[1].strip()
tools={t.get("name") for t in data.get("tools", [])}
assert disabled and disabled not in tools, f"{disabled} still enabled"
assert "version" in tools and "listmodels" in tools, "essential tools missing"
print("ok")
' "$disable_candidate"
        else
          echo "skipped (no disable candidate found)"
        fi

        echo "pal-mcporter selftest: all tools (live smoke)"
        python3 "$_PAL_TOOLS_PY" selftest-spec "$schema_json" | while IFS= read -r spec; do
          tool="$(jq -r '.tool' <<<"$spec")"
          raw="$(jq -c '.raw' <<<"$spec")"
          mapfile -t flags < <(jq -r '.flags[]' <<<"$spec")
          echo "pal-mcporter selftest: $tool"

          if [ "$tool" = "clink" ] && [ -n "${clink_cwd:-}" ]; then
            (cd "$clink_cwd" && node "$_PAL_CLI" -t "$PAL_MCPORTER_TIMEOUT_MS" -o json "$tool" "${flags[@]}" --raw "$raw") \
              | python3 -c 'import json,sys; data=json.load(sys.stdin); status=data.get("status"); assert status, "missing status"; assert status != "error" and not data.get("isError") and not (isinstance(status,str) and status.endswith("_failed")), status; print("ok")'
            continue
          fi

          node "$_PAL_CLI" -t "$PAL_MCPORTER_TIMEOUT_MS" -o json "$tool" "${flags[@]}" --raw "$raw" \
            | python3 -c 'import json,sys; data=json.load(sys.stdin); status=data.get("status"); assert status, "missing status"; assert status != "error" and not data.get("isError") and not (isinstance(status,str) and status.endswith("_failed")), status; print("ok")'
        done
      fi

      echo "pal-mcporter selftest: PASS"
      ;;
    *)
      _run_cli "$@"
      ;;
  esac
}

main "$@"
