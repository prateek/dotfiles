name: install-smoke

on:
  pull_request:
  push:
    branches:
      - master

permissions:
  contents: read

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck
      - name: Shellcheck
        run: |
          shellcheck -x install.sh scripts/macos/apply.sh scripts/macos/capture.sh scripts/macos/gui-apps.sh scripts/vm/test-install-tart.sh

  macos-dry-run:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Zsh syntax check
        run: zsh -n bootstrap.sh

      - name: Install smoke (dry-run)
        run: |
          ./install.sh --core --dry-run
          ./install.sh --full --dry-run

      - name: Remote install smoke (dry-run)
        env:
          REPO_URL: ${{ github.workspace }}
          INSTALL_DIR: ${{ runner.temp }}/dotfiles-install
        run: |
          mkdir -p "${{ runner.temp }}/dotfiles-install-smoke"
          cd "${{ runner.temp }}/dotfiles-install-smoke"
          cat "${{ github.workspace }}/install.sh" | bash -s -- --core --dry-run

      - name: Brewfile parse
        run: |
          brew bundle list --all --file Brewfile.core >/dev/null
          brew bundle list --all --file Brewfile >/dev/null

      - name: Brew bundle (core formulae only)
        env:
          HOMEBREW_BUNDLE_CASK_SKIP: "1"
          HOMEBREW_BUNDLE_MAS_SKIP: "1"
        run: |
          brew bundle install --no-upgrade --file Brewfile.core
