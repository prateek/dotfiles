#!/usr/bin/env zsh
# wt-hook-sparse: Worktrunk hook to apply sparse checkout (cone mode) on worktree creation.
#
# Reads hook context JSON on stdin. Only runs when WT_SPARSE_PATHS is set.

set -euo pipefail
unsetopt xtrace 2>/dev/null || true
set +x 2>/dev/null || true
unsetopt verbose 2>/dev/null || true
set +v 2>/dev/null || true
setopt typeset_silent 2>/dev/null || true

if [[ -z "${WT_SPARSE_PATHS:-}" ]]; then
  exit 0
fi

typeset -a paths
paths=()
typeset -a raw_paths
raw_paths=("${(@f)WT_SPARSE_PATHS}")
typeset p
for p in "${raw_paths[@]}"; do
  [[ -n "$p" ]] && paths+=("$p")
done

if (( ${#paths[@]} == 0 )); then
  exit 0
fi

worktree_path="$(python3 -c 'import json,sys; d=json.load(sys.stdin); print(d.get("worktree_path","") or "")')" || {
  echo "wt-hook-sparse: failed to parse hook JSON on stdin" >&2
  exit 2
}

if [[ -z "${worktree_path}" ]]; then
  echo "wt-hook-sparse: missing worktree_path in hook context" >&2
  exit 2
fi

git -C "$worktree_path" rev-parse --is-inside-work-tree >/dev/null 2>&1 || {
  echo "wt-hook-sparse: not a git worktree: $worktree_path" >&2
  exit 1
}

# Best-effort init (ok if already initialized).
git -C "$worktree_path" sparse-checkout init --cone >/dev/null 2>&1 || true

git -C "$worktree_path" sparse-checkout set --cone -- "${paths[@]}"
